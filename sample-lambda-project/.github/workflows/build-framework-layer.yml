name: Build Framework Layer

# ============================================
# LAYER 2: test_common_framework (private GitHub package)
# This layer rebuilds when framework version is updated
# ============================================

on:
  push:
    branches: [main]
    paths:
      - 'pyproject.toml'      # When framework version changes
  workflow_dispatch:          # Allow manual trigger

env:
  PYTHON_VERSION: "3.11"
  AWS_REGION: "us-east-1"
  LAYER_NAME: "framework-layer"

jobs:
  build-framework-layer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest

      # ============================================
      # Configure Git to access private GitHub repo
      # ============================================
      - name: Configure Git for private GitHub repos
        run: |
          git config --global url."https://${{ secrets.GH_TOKEN }}@github.com/".insteadOf "https://github.com/"

      # ============================================
      # Install ONLY test_common_framework (not PyPI packages)
      # ============================================
      - name: Install framework only
        run: |
          poetry config virtualenvs.in-project true
          poetry install --only framework --no-interaction

          echo "=== Installed framework package ==="
          poetry show

          echo "=== Framework version ==="
          poetry show test-common-framework

      # ============================================
      # Build Lambda Layer
      # ============================================
      - name: Build Lambda Layer
        run: |
          mkdir -p layer/python/lib/python${{ env.PYTHON_VERSION }}/site-packages

          cp -r .venv/lib/python${{ env.PYTHON_VERSION }}/site-packages/* \
            layer/python/lib/python${{ env.PYTHON_VERSION }}/site-packages/

          # Remove unnecessary files
          find layer -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find layer -type f -name "*.pyc" -delete 2>/dev/null || true
          find layer -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true

          echo "=== Layer contents ==="
          ls -la layer/python/lib/python${{ env.PYTHON_VERSION }}/site-packages/

      - name: Package Lambda Layer
        run: |
          cd layer && zip -r ../framework-layer.zip python
          echo "=== Framework Layer zip size ==="
          ls -lh ../framework-layer.zip

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Publish Framework Layer
        run: |
          # Get framework version
          FRAMEWORK_VERSION=$(poetry show test-common-framework 2>/dev/null | grep 'version' | awk '{print $3}' || echo "unknown")

          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name ${{ env.LAYER_NAME }} \
            --description "test_common_framework v${FRAMEWORK_VERSION}" \
            --zip-file fileb://framework-layer.zip \
            --compatible-runtimes python${{ env.PYTHON_VERSION }} \
            --query 'LayerVersionArn' \
            --output text)

          echo "=== Published Framework Layer ==="
          echo "$LAYER_ARN"
          echo "Framework version: $FRAMEWORK_VERSION"

      - name: Summary
        run: |
          FRAMEWORK_VERSION=$(poetry show test-common-framework 2>/dev/null | grep 'version' | awk '{print $3}' || echo "unknown")
          echo "## Framework Layer Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Layer Name:** ${{ env.LAYER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Framework Version:** ${FRAMEWORK_VERSION}" >> $GITHUB_STEP_SUMMARY
