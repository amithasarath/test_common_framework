name: Build PyPI Dependencies Layer

# ============================================
# LAYER 1: PyPI packages (requests, watchtower, opencv, etc.)
# This layer rarely changes - only when PyPI package versions are updated
# ============================================

on:
  push:
    branches: [main]
    paths:
      - 'pyproject.toml'      # Only when dependencies change
  workflow_dispatch:          # Allow manual trigger

env:
  PYTHON_VERSION: "3.11"
  AWS_REGION: "us-east-1"
  LAYER_NAME: "pypi-dependencies-layer"

jobs:
  build-pypi-layer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest

      # ============================================
      # Install ONLY PyPI packages (not framework)
      # ============================================
      - name: Install PyPI dependencies only
        run: |
          poetry config virtualenvs.in-project true
          poetry install --only pypi --no-interaction

          echo "=== Installed PyPI packages ==="
          poetry show

      # ============================================
      # Build Lambda Layer
      # ============================================
      - name: Build Lambda Layer
        run: |
          mkdir -p layer/python/lib/python${{ env.PYTHON_VERSION }}/site-packages

          cp -r .venv/lib/python${{ env.PYTHON_VERSION }}/site-packages/* \
            layer/python/lib/python${{ env.PYTHON_VERSION }}/site-packages/

          # Remove unnecessary files
          find layer -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find layer -type f -name "*.pyc" -delete 2>/dev/null || true
          find layer -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
          find layer -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true

          echo "=== Layer contents ==="
          ls -la layer/python/lib/python${{ env.PYTHON_VERSION }}/site-packages/

      - name: Package Lambda Layer
        run: |
          cd layer && zip -r ../pypi-layer.zip python
          echo "=== PyPI Layer zip size ==="
          ls -lh ../pypi-layer.zip

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Publish PyPI Layer
        run: |
          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name ${{ env.LAYER_NAME }} \
            --description "PyPI packages: requests, watchtower, opencv, boto3, pydantic" \
            --zip-file fileb://pypi-layer.zip \
            --compatible-runtimes python${{ env.PYTHON_VERSION }} \
            --query 'LayerVersionArn' \
            --output text)

          echo "=== Published PyPI Layer ==="
          echo "$LAYER_ARN"

      - name: Summary
        run: |
          echo "## PyPI Dependencies Layer Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Layer Name:** ${{ env.LAYER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Packages included:**" >> $GITHUB_STEP_SUMMARY
          echo "- requests" >> $GITHUB_STEP_SUMMARY
          echo "- watchtower" >> $GITHUB_STEP_SUMMARY
          echo "- opencv-python-headless" >> $GITHUB_STEP_SUMMARY
          echo "- boto3" >> $GITHUB_STEP_SUMMARY
          echo "- pydantic" >> $GITHUB_STEP_SUMMARY
