name: Pre-release Version Update

on:
  push:
    branches-ignore:
      - main

jobs:
  update-prerelease-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get base version and calculate pre-release version
        id: version
        run: |
          # Get base version from main or current
          BASE_VERSION=$(grep -oP '__version__ = "\K[^"]+' test_common_framework/version.py | sed 's/-.*$//')

          # Count commits since branching from main
          COMMIT_COUNT=$(git rev-list --count HEAD ^origin/main 2>/dev/null || echo "1")

          # Get branch name
          BRANCH_NAME="${GITHUB_REF_NAME}"

          # Determine version prefix based on branch type
          # feature/* → feature.N
          # dev       → alpha.N
          # stg       → beta.N
          # others    → alpha.N
          if [[ "$BRANCH_NAME" == feature/* ]]; then
            VERSION_PREFIX="feature"
          elif [[ "$BRANCH_NAME" == "dev" ]]; then
            VERSION_PREFIX="alpha"
          elif [[ "$BRANCH_NAME" == "stg" ]]; then
            VERSION_PREFIX="beta"
          else
            VERSION_PREFIX="alpha"
          fi

          # Create version: 0.1.5-alpha.3 or 0.1.5-feature.3
          PRERELEASE_VERSION="${BASE_VERSION}-${VERSION_PREFIX}.${COMMIT_COUNT}"

          echo "prerelease_version=$PRERELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "version_prefix=$VERSION_PREFIX" >> $GITHUB_OUTPUT
          echo "Pre-release version: $PRERELEASE_VERSION"

      - name: Update version.py with pre-release version
        run: |
          PRERELEASE_VERSION="${{ steps.version.outputs.prerelease_version }}"
          BASE_VERSION="${{ steps.version.outputs.base_version }}"
          IFS='.' read -ra PARTS <<< "$BASE_VERSION"

          cat > test_common_framework/version.py << EOF
          """
          Version information for test_common_framework.

          This file is the single source of truth for the package version.
          - On main branch: Uses rounded versions (e.g., 1.0.0, 1.1.0, 2.0.0)
          - On dev branch: Uses alpha versions (e.g., 1.0.0-alpha.1)
          - On stg branch: Uses beta versions (e.g., 1.0.0-beta.1)
          - On feature branches: Uses feature versions (e.g., 1.0.0-feature.1)
          """

          __version__ = "$PRERELEASE_VERSION"

          # Version components for programmatic access
          VERSION_MAJOR = ${PARTS[0]}
          VERSION_MINOR = ${PARTS[1]}
          VERSION_PATCH = ${PARTS[2]}
          VERSION_SUFFIX = "$(echo $PRERELEASE_VERSION | sed 's/^[0-9.]*-//')"


          def get_version() -> str:
              """Return the full version string."""
              return __version__


          def get_version_tuple() -> tuple:
              """Return version as a tuple (major, minor, patch, suffix)."""
              return (VERSION_MAJOR, VERSION_MINOR, VERSION_PATCH, VERSION_SUFFIX)
          EOF

      - name: Commit pre-release version (if changed)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add test_common_framework/version.py
          git diff --staged --quiet || git commit -m "chore: update pre-release version [skip ci]"
          git push || echo "Nothing to push"
